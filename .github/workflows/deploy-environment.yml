name: Deploy to Environment

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: string
      artifact-name:
        description: 'Name of the build artifact'
        required: true
        type: string
    secrets:
      AZURE_CREDENTIALS:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
      AZURE_OPENAI_API_KEY:
        required: true
      AZURE_OPENAI_ENDPOINT:
        required: false
      YOUTUBE_API_KEY:
        required: true
      YOUTUBE_TRANSCRIPT_API_TOKEN:
        required: true

permissions:
  contents: read
  id-token: write

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      resource-group: ${{ steps.outputs.outputs.resource-group }}
      function-app: ${{ steps.outputs.outputs.function-app }}

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Infrastructure
        run: |
          cd infrastructure
          az deployment sub create \
            --name "indepth-dispenza-${{ inputs.environment }}-$(date +%Y%m%d-%H%M%S)" \
            --location canadacentral \
            --template-file main.bicep \
            --parameters parameters/${{ inputs.environment }}.parameters.json \
            --parameters azureOpenAiApiKey="${{ secrets.AZURE_OPENAI_API_KEY }}" \
            --parameters azureOpenAiEndpoint="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
            --parameters youTubeApiKey="${{ secrets.YOUTUBE_API_KEY }}" \
            --parameters youTubeTranscriptApiToken="${{ secrets.YOUTUBE_TRANSCRIPT_API_TOKEN }}"

      - name: Get Deployment Outputs
        id: outputs
        run: |
          DEPLOYMENT_NAME=$(az deployment sub list \
            --query "[?contains(name, 'indepth-dispenza-${{ inputs.environment }}')].name | [0]" \
            -o tsv)

          RESOURCE_GROUP=$(az deployment sub show \
            --name "$DEPLOYMENT_NAME" \
            --query "properties.outputs.resourceGroupName.value" \
            -o tsv)

          FUNCTION_APP=$(az deployment sub show \
            --name "$DEPLOYMENT_NAME" \
            --query "properties.outputs.functionAppName.value" \
            -o tsv)

          echo "resource-group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
          echo "function-app=$FUNCTION_APP" >> $GITHUB_OUTPUT

  deploy-functions:
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Download Function App artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ./publish

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ needs.deploy-infrastructure.outputs.function-app }}
          package: ./publish

      - name: Wait for Function App to be ready
        run: sleep 30

      - name: Smoke Test - Health Check
        run: |
          FUNCTION_APP="${{ needs.deploy-infrastructure.outputs.function-app }}"

          # Get the function key
          FUNCTION_KEY=$(az functionapp keys list \
            --name "$FUNCTION_APP" \
            --resource-group "${{ needs.deploy-infrastructure.outputs.resource-group }}" \
            --query "functionKeys.default" \
            -o tsv)

          # Call the health endpoint
          HEALTH_URL="https://${FUNCTION_APP}.azurewebsites.net/api/health?code=${FUNCTION_KEY}"

          echo "Testing health endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" "$HEALTH_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body:"
          echo "$BODY" | jq '.' || echo "$BODY"

          # Check if health check succeeded
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✅ Health check passed"

            # Parse and display health status
            STATUS=$(echo "$BODY" | jq -r '.status' 2>/dev/null || echo "unknown")
            echo "Overall Status: $STATUS"

            if [ "$STATUS" != "Healthy" ]; then
              echo "⚠️ Warning: Health status is $STATUS, but continuing deployment"
              echo "$BODY" | jq '.entries' || true
            fi
          else
            echo "❌ Health check failed with HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Deployment Summary
        run: |
          echo "## Deployment Successful ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ needs.deploy-infrastructure.outputs.resource-group }}" >> $GITHUB_STEP_SUMMARY
          echo "**Function App:** ${{ needs.deploy-infrastructure.outputs.function-app }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Smoke Test:** Health check passed" >> $GITHUB_STEP_SUMMARY
