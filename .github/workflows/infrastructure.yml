name: Deploy Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/**'
  pull_request:
    branches:
      - main
    paths:
      - 'infrastructure/**'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  id-token: write  # Required for Azure federated identity

jobs:
  # Validate that commits don't mix infrastructure and code changes
  validate-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for commit analysis

  # Validate Bicep templates
  validate:
    needs: validate-commit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Validate Bicep templates
        run: |
          cd infrastructure
          echo "Validating main.bicep..."
          az bicep build --file main.bicep

          echo "Validating all modules..."
          cd modules
          for file in *.bicep; do
            echo "Validating $file..."
            az bicep build --file "$file"
          done

          echo "✅ All Bicep templates are valid"

  # Deploy to Azure (only on push to main, not PRs)
  deploy:
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: tmp  # Requires manual approval (optional)

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Infrastructure
        run: |
          cd infrastructure

          echo "Deploying to tmp environment..."
          az deployment sub create \
            --name "indepth-dispenza-tmp-$(date +%Y%m%d-%H%M%S)" \
            --location canadacentral \
            --template-file main.bicep \
            --parameters parameters/tmp.parameters.json

      - name: Get Deployment Outputs
        id: outputs
        run: |
          DEPLOYMENT_NAME=$(az deployment sub list \
            --query "[?contains(name, 'indepth-dispenza-tmp')].name | [0]" \
            -o tsv)

          echo "Latest deployment: $DEPLOYMENT_NAME"

          RESOURCE_GROUP=$(az deployment sub show \
            --name "$DEPLOYMENT_NAME" \
            --query "properties.outputs.resourceGroupName.value" \
            -o tsv)

          FUNCTION_APP=$(az deployment sub show \
            --name "$DEPLOYMENT_NAME" \
            --query "properties.outputs.functionAppName.value" \
            -o tsv)

          echo "resource-group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
          echo "function-app=$FUNCTION_APP" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        run: |
          echo "## Infrastructure Deployment Successful ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ steps.outputs.outputs.resource-group }}" >> $GITHUB_STEP_SUMMARY
          echo "**Function App:** ${{ steps.outputs.outputs.function-app }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View resources in [Azure Portal](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ steps.outputs.outputs.resource-group }})" >> $GITHUB_STEP_SUMMARY
